pipeline {
    
    stages {
        stage('Build')
            steps {
                sh '''
                php --version
               composer install
                composer --version
                cp .env.example .env
                php artisan key:generate
               php artisan config:cache
                echo DB_HOST=${DB_HOST} >> .env
                echo DB_USERNAME=${DB_USERNAME} >> .env
                echo DB_DATABASE=${DB_DATABASE} >> .env
               echo DB_PASSWORD=${DB_PASSWORD} >> .env
                ./vendor/bin/phpunit ./tests
                cp .env .env.testing
                php artisan migrate
                '''

            }
        }
        stage('Unit test') {
            steps {
                sh '''
                php artisan test
                '''
            }
        }
        stage('Code coverage') {
            steps {
                sh '''
                vendor/bin/phpunit --coverage-html 'reports/coverage'
                '''
            }
        }
        stage('Static code analysis larastan') {
            steps {
                sh '''
                vendor/bin/phpstan analyse --memory-limit=2G
                '''
            }
        }
        stage('Static code analysis phpcs') {
            steps {
                sh '''
                vendor/bin/phpcs
                '''
            }
        }
        
      
 }
